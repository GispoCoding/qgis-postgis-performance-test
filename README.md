# QGIS feature form performance analysis

This repository provides a sample data and project to reproduce performance issues on QGIS forms.

## Issue description

With a complex database data model and with complex QGIS forms containing many relationships, interacting with the forms is frustratingly slow. In one of our projects opening a feature form might take **40 seconds**! The db in that project is located behind some latency but that certainly doesn't explain the slowness as whole.

What we have found out is that QGIS makes many duplicate heavy load SQL queries to the database which causes at least part of the slowness. Other part comes from the actual latency.

## To reproduce the issue

Prerequirements:
1. (Optional) Configure Postgresql logging as in [pg.conf](pg.conf) to log all statements.
2. Db running on port 5432 (expected by the qgis project)
3. `postgres` user with password `postgres` (expected by the qgis project)

Steps to set up and test the project:
1. Create a db named "qgisdbtest".
2. Create a schema `psql -d qgisdbtest -f data/create_tables.sql`
3. Insert data `psql -d qgisdbtest -f data/insert_sample_data.sql`
4. Open the `qgis-project.qgz` and open a form of some land parcel. 
5. Inspect the PostgreSQL logs

To test with large autogenerated data run:
1. Create data generator functions `psql -f data/data_generator.sql`
2. Run `select generate_random_buildings_and_parcels();`


> **Alternative docker setup**  
> The above can also be set up with docker
> ```
> docker compose up
> ```


### Logs

In the [logs folder](logs) there are logs from PostgreSQL and QGIS Query Logger from the time frame where:
1. Project is opened
2. Lot 5 is clicked with info tool to open the feature form
3. The form is closed


It can be seen from the [PostgreSQL logs](logs/pg_logs-open_project-open_lot5_form-close-form.log) that QGIS generates many duplicate heavy load queries without where clause. For example 
```sql
-- LINE 274
BEGIN READ ONLY;DECLARE qgis_26 BINARY CURSOR FOR SELECT "id","name"::text FROM "qgisdbtest"."land_parcel"
FETCH FORWARD 2000 FROM qgis_26
CLOSE qgis_26;COMMIT

-- LINE 280
BEGIN READ ONLY;DECLARE qgis_28 BINARY CURSOR FOR SELECT "id","name"::text FROM "qgisdbtest"."land_parcel"
FETCH FORWARD 2000 FROM qgis_28
CLOSE qgis_28;COMMIT

-- LINE 286
BEGIN READ ONLY;DECLARE qgis_30 BINARY CURSOR FOR SELECT "id","name"::text FROM "qgisdbtest"."land_parcel"
FETCH FORWARD 2000 FROM qgis_30
CLOSE qgis_30;COMMIT
```

For total **QGIS generates 72 SELECT queries** to the database when opening a feature form of any land parcel in this project.

Also there can be found other duplicate queries. For example:
```sql
SELECT postgis_version()
SELECT postgis_version()
SELECT postgis_version()
```

## Sample data

### Data model
![datamodel](docs/datamodel.png)

### Overview
![overview of the data](docs/screenshot.png)

### QGIS Forms
![QGIS form](docs/qgisform.png)
